<div class="row">
  <div id="ela_chart" class="span6"></div>
  <div id="math_chart" class="span6"></div>
</div>
<div class="row">
  <div class="span12">
  <% @data.each do |subject| %>
  <h2><%= subject[:name] %></h2>
  <table class="table table-bordered table-striped table-condensed tablesorter">
    <thead>
      <tr>
        <th>Grade</th>
        <th>NYS Exam</th>
        <th>Benchmark Average</th>
        <th>Predictive Average</th>
        <th>Progress Based on Benchmark</th>
        <th>Progress Based on Predictive</th>
      </tr>
    </thead>
    <tbody>
      <% subject[:data].each do |row| %>
      <tr>
       <% row.each do |data| %>
        <td><%= data %></td>
       <% end %>
      </tr>
      <% end %>
    </tbody>
  </table>
  <% end %>
  </div>
</div>
<div class="row">
  <div id="ela_bar" class="span6"></div>
  <div id="math_bar" class="span6"></div>
</div>
<div class="row">
  <div id="cep-data-contols" class="span12">
    <div class="well">
    <h1>Analyze Benchmark Data by Subject and Grade</h1>
    <form id="pull-cep-data" style="margin-top: 1em;">
    <select id="select-subject" name="select-subject">
      <% Conversions::Courses::COURSES.each do |k, v| %>
        <option value="<%= k %>"><%= v %></option>
      <% end %>
    </select>
    <select id="select-grade" name="select-grade">
      <% GRADES.each do |g| %>
        <option value="<%= g %>">Grade <%= g %></option>
      <% end %>
    </select>
    <input type="submit" value="Pull in Benchmark Data" class="btn" id="pull-cep-data">
    </form>
  </div>
  </div>
</div>
<div class="row">
  <div id="cep-data" class="span12">
  </div>
</div>


<script type="text/javascript">
  google.load('visualization', '1.0', {'packages':['corechart']});
  google.setOnLoadCallback(drawCharts);

  function drawCharts (){
    $.getJSON('/api/lowest-third', function(dataSet) {
      drawLowestThirdPieChart(dataSet, 'ela', 'ela_chart', 470, 300);
      drawLowestThirdPieChart(dataSet, 'math', 'math_chart', 470, 300);
      drawLowestThirdAverage(dataSet, 'ela', 'ela_bar', 470, 400);
      drawLowestThirdAverage(dataSet, 'math', 'math_bar', 470, 400);
    })
  };

  $(document).ready(function(){
    $('table tbody tr > td').each(
      function(i,e){
        var value = $(e).text()
        if (value < 0) {
          $(e).css('color', 'red')
        } else if (value > 0 && value < 50) {
          $(e).css('color', 'green')
        }
      }
    );
  });
</script>

<script type="text/javascript" charset="utf-8">
 (function () {
   var pullData = function (grade, subject) {
     'use strict';

     var courses = {
      ela: "English",
      library: "Library",
      math: "Mathematics",
      media: "Media Arts",
      music: "Music",
      newspaper: "Newspaper",
      gym: "Physical Education",
      science: "Science",
      socialstudies: "Social Studies",
      spanish: "Spanish",
      tech: "Technology",
      art: "Visual Art"
     }

     $('#cep-data').html('<div class="alert alert-block"><h4>Loading...</h4><p>We are pulling your information in from the database, this should only take a second or two.</p></div>');
     $.getJSON('/api/cep/grade/' + grade + '/subject/' + subject, function (data) {

       var report = $('<div>')
         .addClass('cep-report')
         .addClass('grade' + data.grade)
         .addClass(data.subject);

       $('<h2>Grade ' + data.grade  + ': ' + courses[data.subject] + '</h2>').prependTo(report);

       var createCohortTable = function (i, c) {
         var element, table;
         element = $('<div></div>')
           .append('<h3>' + c.cohort + ': Average Benchmark by Marking Period</h3>');

         table = $('<table class="table table-bordered table-striped table-condensed tablesorter cep-subject-breakdown">\
         <thead>\
         <tr>\
         <th>Group</th>\
         <th>Exam Average</th>\
         <th>T1MP1</th>\
         <th>T1MP2</th>\
         <th>T1MP3</th>\
         <th>T2MP1</th>\
         <th>T2MP2</th>\
         </tr>\
         </thead>\
         <tbody>\
         </tbody>');

         $.each([c.wholeGrade, c.lowestThirdELA, c.lowestThirdMath], function (index, group) {
           var row = $('<tr>');
           row.append('<td class="group-name">' +  group.groupName + '</td>');
           row.append('<td class="exam-average">' +  (group.examAverage || '') + '</td>');
           $.each(group.benchmarkByMarkingPeriod, function (index, mp) {
             row.append('<td class="mp' + mp.mp  + '">' + (mp.score || '') + '</td>')
           });
           row.appendTo(table)
         });

         element.append(table).appendTo(report);
       }

       $.each(data.cohorts, createCohortTable);

       $('#cep-data').text('').addClass('span12');
       report.appendTo('#cep-data');
     });
   };
   
   
   $('document').ready(function () {
     $('#pull-cep-data').submit(function (event) {
        event.preventDefault();
        console.log('Pressed: ' + $('#select-grade').attr('value') + ', ' + $('#select-subject').attr('value'))
        pullData($('#select-grade').attr('value'), $('#select-subject').attr('value'));
        console.log('Pulled')
      });
   });
 })();
 </script>